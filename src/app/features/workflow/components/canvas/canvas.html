<app-undo-redo
  [canUndo]="canUndo"
  [canRedo]="canRedo"
  (undo)="undo()"
  (redo)="redo()"
></app-undo-redo>

<app-canvas-actions
  (autoLayout)="applyAutoLayout()"
  (center)="resetScaleAndCenter()"
  (zoomIn)="zoomIn()"
  (zoomOut)="zoomOut()"
/>

<!-- Componente principal do canva -->
<f-flow
  fDraggable
  [vCellSize]="32"
  [hCellSize]="32"
  (fLoaded)="onLoaded()"
  (fReassignConnection)="(null)"
  (fMoveNodes)="onMoveNodes($event)"
  (fCreateNode)="onCreateNode($event)"
  (fCreateConnection)="onCreateConnection($event)"
  (fSelectionChange)="onChangeSelection($event)"
>
  <!-- Fundo do canva -->
  <f-background>
    <!-- Padrão com pontinhos -->
    <f-circle-pattern [radius]="24" />
  </f-background>

  <f-canvas [fZoom]="true" [debounceTime]="200">
    <f-snap-connection [fSnapThreshold]="50" [fType]="eConnectionType.SEGMENT"></f-snap-connection>

    <f-connection-for-create fBehavior="fixed" [fType]="eConnectionType.SEGMENT" [fOffset]="32">
      <!-- Ponta da seta durante criação da conexão -->
      <svg
        id="normal_end"
        viewBox="0 0 700 700"
        fMarker
        [type]="eMarkerType.END"
        [height]="5"
        [width]="5"
        [refX]="4"
        [refY]="2.5"
      >
        <path d="M0,0 L700,350 L0,700 Z" />
      </svg>
    </f-connection-for-create>

    <!-- Imprime todas as conexões -->
    @for (connection of connections(); track connection.id) {
      <f-connection
        [fReassignDisabled]="true"
        [fOutputId]="connection.source"
        [fInputId]="connection.target"
        fBehavior="fixed"
        [fOffset]="32"
        [fType]="eConnectionType.SEGMENT"
      >
        <!-- Ponta da seta -->
        <svg
          id="normal_end"
          viewBox="0 0 700 700"
          fMarker
          [type]="eMarkerType.END"
          [height]="5"
          [width]="5"
          [refX]="4"
          [refY]="2.5"
        >
          <path d="M0,0 L700,350 L0,700 Z" />
        </svg>

        <!-- Ponta da seta (selecionada) -->
        <svg
          id="selected_end"
          viewBox="0 0 700 700"
          fMarker
          [type]="eMarkerType.SELECTED_END"
          [height]="5"
          [width]="5"
          [refX]="4"
          [refY]="2.5"
        >
          <path d="M0,0 L700,350 L0,700 Z" />
        </svg>
      </f-connection>
    }

    <!-- Imprime todos os nós -->
    @for (node of nodes(); track node.id) {
      <div
        fNode
        fDragHandle
        [fNodeId]="node.id"
        [fNodePosition]="node.position"
        fOutputConnectableSide="right"
        fInputConnectableSide="left"
        [ngClass]="node.category"
      >
        <!-- Ações do nó (info, configuração, duplicar e excluir) -->
        <app-node-actions/>

        <!-- Ícone do componente -->
        <img [src]="node.icon" class="node-icon" />

        <!-- Título do componente -->
        <div class="node-label">
          <span>{{ node.title }}</span>
        </div>

        <!-- Ponto para receber uma conexão (círculo do lado esquerdo) -->
        @if (node.category !== 'start') {
          <div
            class="left"
            fNodeInput
            [fInputId]="node.id + '-input'"
            [fInputCategory]="node.category"
          ></div>
        }

        <!-- Ponto para iniciar uma conexão (círculo do lado direito) -->
        <div
          class="right"
          fNodeOutput
          [fOutputId]="node.id + '-output'"
          [isSelfConnectable]="false"
          [fOutputMultiple]="true"
          [fCanBeConnectedInputs]="['component']"
        ></div>
      </div>
    }
  </f-canvas>
</f-flow>
